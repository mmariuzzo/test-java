# SPID/CIE OIDC Federation Starter Kit

Both Snapshots and Released artifacts are available on [GitHub Packages](https://github.com/orgs/italia/packages?repo_name=spid-cie-oidc-java):

* if you use Maven

```xml
<dependency>
  <groupId>it.spid.cie.oidc</groupId>
  <artifactId>it.spid.cie.oidc.starter.kit</artifactId>
  <version><!--replace with the wanted version --></version>
</dependency>
```

* if you use Gradle

```gradle
implementation group: 'it.spid.cie.oidc', name: 'it.spid.cie.oidc.starter.kit', version: 'xxx'
```

Unfortunately, as stated in the [documentation](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-apache-maven-registry#authenticating-to-github-packages), to use GitHub packages you have define GitHub repository in your `~/.m2/settings.xml` together with your credentials.


The "starter-kit" is a _backend_ library with few dependencies:
* [`org.json:json`](https://github.com/stleary/JSON-java), a simple and light-weigth to parse and create JSON documents
* [`com.nimbusds:nimbus-jose-jwt`](https://connect2id.com/products/nimbus-jose-jwt), the most popular java Library to manage JSON Web Token (JWT, JWE, JWS)
* [`com.github.stephenc.jcip:jcip-annotations:1.0-1`](https://mvnrepository.com/artifact/com.github.stephenc.jcip/jcip-annotations/1.0-1), a clean room implementation of the JCIP Annotations
* [`org.slf4j:slf4j-api`](https://mvnrepository.com/artifact/org.slf4j/slf4j-api)


## PersistenceAdapter

The starter-kit doesn't interact directly with the database: it delegates to the implementer this job.

It exposes an interface, called [`PersistenceAdapter`](/starter-kit/src/main/java/it/spid/cie/oidc/persistence/PersistenceAdapter.java), and in the implementing class your application is free to use the database engine and the integration framework more suitable.

The starter-kit manages the following models:
* `FederationEntity`. Contains all the elements needed to describe an Entity members of the Federation
* `CachedEntityInfo`. An _EntityInfo_ is the set of elements (the statement) the Federation Authority has about a Federation Entity. We have to cache this information to reduce network overhead
* `TrustChain`. Contains all the elements needed to describe the "chain of trust" between two Federation Entity.
* `AuthnRequest`. Describe an Authentication Request and helps to track the authentication flow
* `AuthnToken`. Contains the Authentication Token and the Claims received on the authentication flow

Every model contains these _helping_ attributes:
* `createDate`
* `modifiedDate`
* `storageId`


The SpringBoot example project uses H2 as database engine and interact with it using a specific SpringBoot data framework. In the example:
* there are annotated model classes able to marshalling/unmarshalling with starter-kit models
* the class implementing PersistenceAdapter interact with data framework to store the information or to find it. 


## Configuration Options

The class [`RelyingPartyOptions`](/starter-kit/src/main/java/it/spid/cie/oidc/config/RelyingPartyOptions.java) contains all the defaults and the limits for a RelyingParty implementation.

Many options can be customized by your application. Some of them have to be customized because no defaults are present. An example of  minimum, mandatory, configuration can be

```java
		Map<String, String> spidProviders = new HashMap<>();

		spidProviders.put(<SPID_PROVIDER>, <TRUST_ANCHOR>);

		RelyingPartyOptions options = new RelyingPartyOptions()
			.setDefaultTrustAnchor(<TRUST_ANCHOR>)
			.setClientId(<RELYING_PARTY>)
			.setSPIDProviders(spidProviders)
			.setTrustAnchors(ArrayUtil.asSet(<TRUST_ANCHOR>))
			.setApplicationName("Sample RP")
			.setRedirectUris(ArrayUtil.asSet(<RELYING_PARTY> + "callback"))
			.setJWK(<RELYING_PARTY_JWK>)
			.setTrustMarks(<RELYING_PARTY_TRUST_MARKS>);
```

where:
* `<TRUST_ANCHOR>` is the Trust Anchor subject (es: `http.//trust-anchor.org/`)
* `<SPID_PROVIDER>` is the SPID Provider subject (es: `http://spid-provider.org/oidc/op/`)
* `<RELYING_PARTY>` is the RelyingParty subject (es: `http://my-relying-party.org/oidc/rp/`)
* `<RELYING_PARTY_JWK>` is the string representation of a JSON WebKey (JWK), with both private and public parts, of your RelyingParty. This JWK is generated in the on-boarding flow as described below
* `<RELYING_PARTY_TRUST_MARKS>` is the string representation of the TrustMarks generated by the Federation Authority at the end of the on-boarding flow


## OIDCException

The starter-kit throws different application Exceptions but all of them are or extends `OIDCException`. Also standard Exceptions are rethrows as specific OIDCExceptions.

This allows you code to be more flexible: you don't have to change method signature when a new kind of OIDCExcetion will be implemented.



## RelyingParty Handler

The [`RelyingPartyHandler`](/starter-kit/src/main/java/it/spid/cie/oidc/handler/RelyingPartyHandler.java) class is the main element of the starter-kit for the RelyingParty _role_.

To istantiate the class you have to provider the options and the PersistenceAdapter implementation. The correctness of these elements is checked immediately in the constructor.

```java
RelyingPartyHandler handler = new RelyingPartyHandler(options, persistenceAdapter);
```

A good approach is to instantiate only one handler per application (or per tenant) and to re-instantiate it when configuration changes.

